/**
 * Poll the server to keep the session alive.
 *
 * @module     core/network
 * @copyright  2019 Damyon Wiese
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("core/network",["jquery","core/ajax","core/config","core/notification","core/str"],(function($,Ajax,Config,Notification,Str){var started=!1,warningDisplayed=!1,keepAliveFrequency=0,requestTimeout=0,keepAliveMessage=!1,sessionTimeout=!1,checkFrequency=1e3*Math.min(Config.sessiontimeout/10,600),warningLimit=2*checkFrequency,timeoutSessionExpired=function(){sessionTimeout=!0},touchSession=function touchSession(){return sessionTimeout?Str.get_strings([{key:"sessionexpired",component:"error"},{key:"sessionerroruser",component:"error"}]).then((function(strings){return Notification.alert(strings[0],strings[1]),!0})).fail(Notification.exception):Ajax.call([{methodname:"core_session_touch",args:{}}],!0,!0,!1,requestTimeout)[0].then((function(){return keepAliveFrequency>0&&setTimeout(touchSession,keepAliveFrequency),!0})).fail((function(){Notification.alert("",keepAliveMessage)}))},checkSession=function checkSession(){return sessionTimeout=!1,Ajax.call([{methodname:"core_session_time_remaining",args:{}}],!0,!0,!0)[0].then((function(args){return!(args.userid<=0)&&(args.timeremaining<0?Str.get_strings([{key:"sessionexpired",component:"error"},{key:"sessionerroruser",component:"error"}]).then((function(strings){return Notification.alert(strings[0],strings[1]),!0})).fail(Notification.exception):1e3*args.timeremaining<warningLimit&&!warningDisplayed?(setTimeout(timeoutSessionExpired,1e3*args.timeremaining),warningDisplayed=!0,Str.get_strings([{key:"norecentactivity",component:"moodle"},{key:"sessiontimeoutsoon",component:"moodle"},{key:"extendsession",component:"moodle"},{key:"cancel",component:"moodle"}]).then((function(strings){return Notification.confirm(strings[0],strings[1],strings[2],strings[3],(function(){return touchSession(),warningDisplayed=!1,setTimeout(checkSession,5*checkFrequency),!0}),(function(){warningDisplayed=!1,setTimeout(checkSession,checkFrequency)})),!0})).fail(Notification.exception)):setTimeout(checkSession,checkFrequency),!0)}))},start=function(){keepAliveFrequency>0?setTimeout(touchSession,keepAliveFrequency):setTimeout(checkSession,5*checkFrequency)},isMoodleIframe=function(){if(window.parent===window)return!1;var parentUrl;try{parentUrl=window.parent.location.href}catch(e){return!1}return parentUrl.startsWith(M.cfg.wwwroot)};return{keepalive:function(freq,timeout,message){started?window.console.warn("Ignoring session keep-alive. The core/network module was already initialised."):(started=!0,isMoodleIframe()?window.console.warn("Ignoring session keep-alive in this iframe inside another Moodle page."):(window.console.log("Starting Moodle session keep-alive."),keepAliveFrequency=1e3*freq,keepAliveMessage=message,requestTimeout=1e3*timeout,start()))},init:function(){started||(started=!0,isMoodleIframe()?window.console.log("Not starting Moodle session timeout warning in this iframe."):(window.console.log("Starting Moodle session timeout warning."),start()))}}}));

//# sourceMappingURL=network.min.js.map